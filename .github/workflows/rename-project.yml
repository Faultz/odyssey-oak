name: Rename Project

on:
  workflow_dispatch:
    inputs:
      new_name:
        description: 'New project name (e.g., my-awesome-game)'
        required: true
        type: string

permissions:
  contents: write
  actions: write

jobs:
  rename:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate input
        run: |
          NEW_NAME="${{ github.event.inputs.new_name }}"
          
          # Check if name is empty
          if [ -z "$NEW_NAME" ]; then
            echo "Error: Project name cannot be empty"
            exit 1
          fi
          
          # Check for valid characters (alphanumeric, hyphens, underscores)
          if ! [[ "$NEW_NAME" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
            echo "Error: Project name must start with a letter and contain only letters, numbers, hyphens, and underscores"
            exit 1
          fi
          
          echo "New project name: $NEW_NAME"

      - name: Rename project files and update references
        run: |
          OLD_NAME="odyssey-game"
          NEW_NAME="${{ github.event.inputs.new_name }}"
          
          echo "Renaming project from '$OLD_NAME' to '$NEW_NAME'"
          
          # Step 1: Update content inside files first (before renaming)
          echo "Updating file contents..."
          
          # Update the solution file
          if [ -f "$OLD_NAME.sln" ]; then
            sed -i "s/$OLD_NAME/$NEW_NAME/g" "$OLD_NAME.sln"
            echo "Updated: $OLD_NAME.sln"
          fi
          
          # Update the vcxproj file
          if [ -f "$OLD_NAME/$OLD_NAME.vcxproj" ]; then
            sed -i "s/$OLD_NAME/$NEW_NAME/g" "$OLD_NAME/$OLD_NAME.vcxproj"
            echo "Updated: $OLD_NAME/$OLD_NAME.vcxproj"
          fi
          
          # Update the vcxproj.filters file
          if [ -f "$OLD_NAME/$OLD_NAME.vcxproj.filters" ]; then
            sed -i "s/$OLD_NAME/$NEW_NAME/g" "$OLD_NAME/$OLD_NAME.vcxproj.filters"
            echo "Updated: $OLD_NAME/$OLD_NAME.vcxproj.filters"
          fi
          
          # Update the vcxproj.user file if it exists
          if [ -f "$OLD_NAME/$OLD_NAME.vcxproj.user" ]; then
            sed -i "s/$OLD_NAME/$NEW_NAME/g" "$OLD_NAME/$OLD_NAME.vcxproj.user"
            echo "Updated: $OLD_NAME/$OLD_NAME.vcxproj.user"
          fi
          
          # Update any references in source files (optional, for namespace/class names)
          find "$OLD_NAME" -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.hpp" \) -exec sed -i "s/$OLD_NAME/$NEW_NAME/g" {} \;
          echo "Updated source files"
          
          # Step 2: Rename files
          echo "Renaming files..."
          
          # Rename vcxproj files inside the project folder
          if [ -f "$OLD_NAME/$OLD_NAME.vcxproj" ]; then
            mv "$OLD_NAME/$OLD_NAME.vcxproj" "$OLD_NAME/$NEW_NAME.vcxproj"
            echo "Renamed: $OLD_NAME.vcxproj -> $NEW_NAME.vcxproj"
          fi
          
          if [ -f "$OLD_NAME/$OLD_NAME.vcxproj.filters" ]; then
            mv "$OLD_NAME/$OLD_NAME.vcxproj.filters" "$OLD_NAME/$NEW_NAME.vcxproj.filters"
            echo "Renamed: $OLD_NAME.vcxproj.filters -> $NEW_NAME.vcxproj.filters"
          fi
          
          if [ -f "$OLD_NAME/$OLD_NAME.vcxproj.user" ]; then
            mv "$OLD_NAME/$OLD_NAME.vcxproj.user" "$OLD_NAME/$NEW_NAME.vcxproj.user"
            echo "Renamed: $OLD_NAME.vcxproj.user -> $NEW_NAME.vcxproj.user"
          fi
          
          # Rename PCH files if they exist
          for dir in "$OLD_NAME/ORBIS_Debug" "$OLD_NAME/ORBIS_Release"; do
            if [ -d "$dir" ]; then
              for file in "$dir/$OLD_NAME".*; do
                if [ -f "$file" ]; then
                  newfile="${file/$OLD_NAME/$NEW_NAME}"
                  mv "$file" "$newfile"
                  echo "Renamed: $file -> $newfile"
                fi
              done
            fi
          done
          
          # Rename output files in build directories
          for dir in "ORBIS_Debug" "ORBIS_Release"; do
            if [ -d "$dir" ]; then
              for file in "$dir/$OLD_NAME".*; do
                if [ -f "$file" ]; then
                  newfile="${file/$OLD_NAME/$NEW_NAME}"
                  mv "$file" "$newfile"
                  echo "Renamed: $file -> $newfile"
                fi
              done
            fi
          done
          
          # Step 3: Rename the project folder
          if [ -d "$OLD_NAME" ]; then
            mv "$OLD_NAME" "$NEW_NAME"
            echo "Renamed folder: $OLD_NAME -> $NEW_NAME"
          fi
          
          # Step 4: Rename the solution file
          if [ -f "$OLD_NAME.sln" ]; then
            mv "$OLD_NAME.sln" "$NEW_NAME.sln"
            echo "Renamed: $OLD_NAME.sln -> $NEW_NAME.sln"
          fi
          
          echo "Project rename complete!"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          git commit -m "Rename project from odyssey-game to ${{ github.event.inputs.new_name }}"
          git push
